import{colors as y,fs as _,path as w}from"@vuepress/utils";import{isLinkHttp as C,removeEndingSlash as x,removeLeadingSlash as D}from"@vuepress/shared";import{Logger as R,deepMerge as M,encodeXML as m,encodeCDATA as S,stripTags as E,isUrl as j,getPageText as J,getAuthor as I,getCategory as G,getPageExcerpt as H,isAbsoluteUrl as T}from"vuepress-shared/node";import{js2xml as L}from"xml-js";const A="vuepress-plugin-feed2",v=new R(A),P=(i,t)=>!i||!(i instanceof Date)?1:!t||!(t instanceof Date)?-1:t.getTime()-i.getTime(),f=(i,t="",e="")=>`${C(i)?x(i):`https://${x(i)}`}${t}${D(e)}`,K=(i="")=>`image/${i==="jpg"?"jpeg":i==="svg"?"svg+xml":i==="jpeg"||i==="png"||i==="bmp"||i==="gif"||i==="webp"?i:""}`,W=(i,t,e="",a="")=>{t in i&&(v.error(`"${y.magenta(t)}" is ${y.red("removed")}${a?`, please use ${y.magenta(a)} instead.`:" and no longer supported"}${e?`
${e}`:""}`),a||delete i[t])},q=i=>{var t,e,a,r,n,o,s,u,l,p,d,c;i.atom=((e=(t=i.output)==null?void 0:t.atom)==null?void 0:e.enable)??!0,i.json=((r=(a=i.output)==null?void 0:a.json)==null?void 0:r.enable)??!0,i.rss=((o=(n=i.output)==null?void 0:n.rss)==null?void 0:o.enable)??!0,i.atomOutputFilename=((u=(s=i.output)==null?void 0:s.atom)==null?void 0:u.path)??"atom.xml",i.jsonOutputFilename=((p=(l=i.output)==null?void 0:l.json)==null?void 0:p.path)??"feed.json",i.jsonOutputFilename=((c=(d=i.output)==null?void 0:d.rss)==null?void 0:c.path)??"rss.xml",W(i,"output")},B=i=>i.hostname?(i.hostname=C(i.hostname)?x(i.hostname):`https://${x(i.hostname)}`,!0):!1,X=i=>i.locales&&Object.entries(i.locales).some(([,{atom:t,json:e,rss:a}])=>t||e||a)||Boolean(i.atom||i.json||i.rss),z=({siteData:i},t)=>Object.fromEntries(Object.keys({"/":{},...i.locales}).map(e=>{var a;return[e,{filter:({frontmatter:r,filePathRelative:n})=>!(r.home||!n||r.article===!1||r.feed===!1),sorter:(r,n)=>{var o,s,u,l;return P((o=r.data.git)!=null&&o.createdTime?new Date((s=r.data.git)==null?void 0:s.createdTime):r.frontmatter.date,(u=n.data.git)!=null&&u.createdTime?new Date((l=n.data.git)==null?void 0:l.createdTime):n.frontmatter.date)},...t,...(a=t.locales)==null?void 0:a[e],hostname:t.hostname}]})),Q=(i,t,e="")=>{var a,r,n,o,s,u,l;const{base:p}=i.options,{title:d,description:c,lang:g,locales:h}=i.siteData,{hostname:O,icon:b,image:U}=t,F=(r=(a=t.channel)==null?void 0:a.author)==null?void 0:r.name,N={title:((n=h[e])==null?void 0:n.title)||d||((o=h["/"])==null?void 0:o.title)||"",link:f(O,p,e),description:((s=h[e])==null?void 0:s.description)||c||((u=h["/"])==null?void 0:u.description)||"",language:((l=h[e])==null?void 0:l.lang)||g,copyright:F?`Copyright by ${F}`:"",pubDate:new Date,lastUpdated:new Date,...b?{icon:b}:{},...U?{image:U}:{},...F?{author:{name:F}}:{}};return M(N,t.channel||{})},k=(i,t="/")=>({atomOutputFilename:`${D(t)}${i.atomOutputFilename||"atom.xml"}`,jsonOutputFilename:`${D(t)}${i.jsonOutputFilename||"feed.json"}`,rssOutputFilename:`${D(t)}${i.rssOutputFilename||"rss.xml"}`}),V=({options:{base:i}},t)=>{const{hostname:e}=t,{atomOutputFilename:a,jsonOutputFilename:r,rssOutputFilename:n}=k(t);return{atom:f(e,i,a),json:f(e,i,r),rss:f(e,i,n)}},Y=(i,t)=>{const{base:e}=i.options,{siteData:a}=i,r=Object.keys(t);if(r.length===1){const{atomOutputFilename:n,jsonOutputFilename:o,rssOutputFilename:s}=k(t["/"]),{atom:u,json:l,rss:p,hostname:d}=t["/"],c=(g,h,O)=>{var b;return["link",{rel:"alternate",type:O,href:f(d,e,h),title:`${a.title||((b=a.locales["/"])==null?void 0:b.title)||""} ${g} Feed`}]};a.head||(a.head=[]),u&&a.head.push(c("Atom",n,"application/atom+xml")),l&&a.head.push(c("JSON",o,"application/json")),p&&a.head.push(c("RSS",s,"application/rss+xml"))}else i.pages.forEach(n=>{const{pathLocale:o}=n,s=t[o];if(r.includes(o)){const{atomOutputFilename:u,jsonOutputFilename:l,rssOutputFilename:p}=k(s,o),d=(c,g,h)=>{var O,b;return["link",{rel:"alternate",type:h,href:f(s.hostname,e,g),title:`${((O=a.locales[o])==null?void 0:O.title)||a.title||((b=a.locales["/"])==null?void 0:b.title)||""} ${c} Feed`}]};n.frontmatter.head||(n.frontmatter.head=[]),s.atom&&n.frontmatter.head.push(d("Atom",u,"application/atom+xml")),s.json&&n.frontmatter.head.push(d("JSON",l,"application/json")),s.rss&&n.frontmatter.head.push(d("RSS",p,"application/rss+xml"))}})},$=i=>{const{name:t="Unknown",email:e,url:a}=i;return{name:t,...e?{email:e}:{},...a?{uri:m(a)}:{}}},Z=i=>{const{name:t,scheme:e=""}=i;return{_attributes:{term:t,scheme:e}}},tt=i=>{const{channel:t,links:e}=i.options,a={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},feed:{_attributes:{xmlns:"http://www.w3.org/2005/Atom",...t.language?{"xml:lang":t.language}:{}},id:t.link,title:t.title,...t.description?{subtitle:t.description}:{},...t.author?{author:$(t.author)}:{},updated:t.lastUpdated?t.lastUpdated.toISOString():new Date().toISOString(),generator:A,link:[{_attributes:{rel:"self",href:m(e.atom)}}]}};return t.link&&a.feed.link.push({_attributes:{rel:"alternate",href:m(t.link)}}),t.hub&&a.feed.link.push({_attributes:{rel:"hub",href:m(t.hub)}}),t.image&&(a.feed.logo=t.image),t.icon&&(a.feed.icon=t.icon),t.copyright&&(a.feed.rights=t.copyright),a.feed.category=Array.from(i.categories).map(r=>({_attributes:{term:r}})),a.feed.contributor=Array.from(i.contributors).filter(r=>r.name).map(r=>$(r)),a.feed.entry=i.items.map(r=>{const n={title:{_attributes:{type:"html"},_text:m(r.title)},id:m(r.guid||r.link),link:{_attributes:{href:m(r.link)}},updated:r.lastUpdated.toISOString()};return r.description&&(n.summary=r.description.startsWith("html:")?{_attributes:{type:"html"},_cdata:S(r.description.substring(5))}:{_attributes:{type:"html"},_text:r.description}),r.content&&(n.content={_attributes:{type:"html"},_cdata:S(r.content)}),r.author&&(n.author=r.author.filter(o=>o.name).map(o=>$(o))),r.category&&(n.category=r.category.map(o=>Z(o))),r.contributor&&(n.contributor=r.contributor.map(o=>$(o))),r.pubDate&&(n.published=r.pubDate.toISOString()),r.copyright&&(n.rights=r.copyright),n}),L(a,{compact:!0,ignoreComment:!0,spaces:2})},et=i=>({name:i.name,...i.url?{url:i.url}:{},...i.avatar?{avatar:i.avatar}:{}}),it=i=>{var t;const{channel:e,links:a}=i.options,r={version:"https://jsonfeed.org/version/1.1",title:e.title,home_page_url:e.link,feed_url:a.json};return e.description&&(r.description=e.description),e.image&&(r.icon=e.image),e.icon&&(r.favicon=e.icon),(t=e.author)!=null&&t.name&&(r.author={name:e.author.name,...e.author.url?{url:e.author.url}:{},...e.author.avatar?{avatar:e.author.avatar}:{}}),r.items=i.items.map(n=>{const o={title:n.title,url:n.link,id:n.guid||n.link,...n.description?{summary:n.description.startsWith("html:")?E(n.description.substring(5)):n.description}:{},content_html:n.content};return n.image&&(o.image=n.image),n.pubDate&&(o.date_published=n.pubDate.toISOString()),n.lastUpdated&&(o.date_modified=n.lastUpdated.toISOString()),Array.isArray(n.author)&&(o.authors=n.author.filter(s=>s.name).map(s=>et(s))),n.category&&(o.tags=n.category.filter(s=>s.name).map(s=>s.name)),o}),JSON.stringify(r,null,2)},nt=i=>{const{name:t,domain:e}=i;return{_text:t,...e?{_attributes:{domain:e}}:{}}},at=i=>{const t=i.guid||m(i.link);return{...j(t)?{}:{_attributes:{isPermaLink:!1}},_text:t}},rt=i=>({_attributes:{url:i.url,...i.length?{length:i.length}:{},...i.type?{type:i.type}:{}}}),ot=i=>{const{links:t,channel:e}=i.options;let a=!1;const r={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},rss:{_attributes:{version:"2.0","xmlns:atom":"http://www.w3.org/2005/Atom"},channel:{"atom:link":{_attributes:{href:t.rss,rel:"self",type:"application/rss+xml"}},title:{_text:e.title},link:{_text:m(e.link)},description:{_text:e.description},language:{_text:m(e.language)},pubDate:{_text:e.pubDate?e.pubDate.toUTCString():new Date().toUTCString()},lastBuildDate:{_text:e.lastUpdated?e.lastUpdated.toUTCString():new Date().toUTCString()},generator:{_text:A},docs:{_text:"https://validator.w3.org/feed/docs/rss2.html"}}}};return e.copyright&&(r.rss.channel.copyright={_text:e.copyright}),e.ttl&&(r.rss.channel.ttl={_text:e.ttl.toString()}),e.image&&(r.rss.channel.image={title:{_text:e.title},url:{_text:e.image},link:{_text:m(e.link)}}),r.rss.channel.category=Array.from(i.categories).map(n=>({_text:n})),r.rss.channel.item=i.items.map(n=>{const o={title:{_text:m(n.title)},link:{_text:m(n.link)},guid:at(n),source:{_attributes:{url:t.rss},_text:n.title}};if(n.description&&(o.description={_text:n.description.startsWith("html:")?E(n.description.substring(5)):n.description}),n.author){const s=n.author.find(u=>u.email&&u.name);s&&(o.author={_text:`${s.email} (${s.name})`})}return n.category&&(o.category=n.category.filter(s=>s.name).map(s=>nt(s))),n.comments&&(o.comments={_text:m(n.link)}),n.pubDate&&(o.pubDate={_text:n.pubDate.toUTCString()}),n.content&&(a=!0,o["content:encoded"]={_cdata:S(n.content)}),n.enclosure&&(o.enclosure=rt(n.enclosure)),o}),a&&(r.rss._attributes["xmlns:content"]="http://purl.org/rss/1.0/modules/content/",r.rss._attributes["xmlns:dc"]="http://purl.org/dc/elements/1.1/"),L(r,{compact:!0,ignoreComment:!0,spaces:2})};class st{constructor(t){this.options=t,this.items=[],this.categories=new Set,this._contributorKeys=new Set,this.contributors=[],this.addItem=e=>{this.items.push(e)},this.addCategory=e=>{this.categories.add(e)},this.addContributor=e=>{const a=e.email||e.name;a&&!this._contributorKeys.has(a)&&(this._contributorKeys.add(a),this.contributors.push(e))},this.atom=()=>tt(this),this.rss=()=>ot(this),this.json=()=>it(this)}}class lt{constructor(t,e,a,r){this.app=t,this.options=e,this.page=a,this.feed=r,this.base=this.app.options.base,this.frontmatter=a.frontmatter,this.getter=e.getter||{},this.pageFeedOptions=this.frontmatter.feed||{}}get title(){return typeof this.getter.title=="function"?this.getter.title(this.page):this.pageFeedOptions.title||this.page.title}get link(){return typeof this.getter.link=="function"?this.getter.link(this.page):f(this.options.hostname,this.base,this.page.path)}get description(){if(typeof this.getter.description=="function")return this.getter.description(this.page);if(this.pageFeedOptions.description)return this.pageFeedOptions.description;if(this.frontmatter.description)return this.frontmatter.description;const t=J(this.page);return t.length>180?`${t.slice(0,177)}...`:t}get author(){var t,e;return typeof this.getter.author=="function"?this.getter.author(this.page):Array.isArray(this.pageFeedOptions.author)?this.pageFeedOptions.author:typeof this.pageFeedOptions.author=="object"?[this.pageFeedOptions.author]:this.frontmatter.author===!1?[]:this.frontmatter.author?I(this.frontmatter.author):(t=this.options.channel)!=null&&t.author?I((e=this.options.channel)==null?void 0:e.author):[]}get category(){if(typeof this.getter.category=="function")return this.getter.category(this.page);if(Array.isArray(this.pageFeedOptions.category))return this.pageFeedOptions.category;if(typeof this.pageFeedOptions.category=="object")return[this.pageFeedOptions.category];const{categories:t,category:e=t}=this.frontmatter;return G(e).map(a=>({name:a}))}get enclosure(){return typeof this.getter.enclosure=="function"?this.getter.enclosure(this.page):this.image?{url:this.image,type:K(this.image.split(".").pop())}:null}get guid(){return this.pageFeedOptions.guid||this.link}get pubDate(){if(typeof this.getter.publishDate=="function")return this.getter.publishDate(this.page);const{time:t,date:e=t}=this.page.frontmatter,{createdTime:a}=this.page.data.git||{};return e&&e instanceof Date?e:a?new Date(a):null}get lastUpdated(){if(typeof this.getter.lastUpdateDate=="function")return this.getter.lastUpdateDate(this.page);const{updatedTime:t}=this.page.data.git||{};return t?new Date(t):new Date}get content(){return typeof this.getter.content=="function"?this.getter.content(this.page):this.pageFeedOptions.content?this.pageFeedOptions.content:H(this.app,this.page,{excerptLength:1/0})}get image(){if(typeof this.getter.image=="function")return this.getter.image(this.page);const{banner:t,cover:e}=this.frontmatter;if(t){if(T(t))return f(this.options.hostname,this.app.options.base,t);if(j(t))return t}if(e){if(T(e))return f(this.options.hostname,this.app.options.base,e);if(j(e))return e}const a=/!\[.*?\]\((.*?)\)/iu.exec(this.page.content);if(a){if(T(a[1]))return f(this.options.hostname,this.app.options.base,a[1]);if(j(a[1]))return a[1]}return null}get contributor(){return typeof this.getter.contributor=="function"?this.getter.contributor(this.page):Array.isArray(this.pageFeedOptions.contributor)?this.pageFeedOptions.contributor:typeof this.pageFeedOptions.contributor=="object"?[this.pageFeedOptions.contributor]:this.author}get copyright(){if(typeof this.getter.copyright=="function")return this.getter.copyright(this.page);if(this.frontmatter.copyright)return this.frontmatter.copyright;const t=this.author[0];return t!=null&&t.name?`Copyright by ${t.name}`:null}getFeedItem(){const{author:t,category:e,content:a,contributor:r,copyright:n,description:o,enclosure:s,guid:u,image:l,lastUpdated:p,link:d,pubDate:c,title:g}=this;return!g&&!o?null:(e&&e.forEach(h=>this.feed.addCategory(h.name)),r&&r.forEach(h=>this.feed.addContributor(h)),{title:g,link:d,guid:u,lastUpdated:p,content:a,author:t,contributor:r,...o?{description:o}:{},...e?{category:e}:{},...s?{enclosure:s}:{},...c?{pubDate:c}:{},...l?{image:l}:{},...n?{copyright:n}:{}})}}class ut{constructor(t,e){this.app=t,this.options=e,this.feedMap=Object.fromEntries(Object.entries(e).map(([a,r])=>[a,new st({channel:Q(t,r,a),links:V(t,r)})]))}addPages(t){const e=this.feedMap[t],a=this.options[t],{count:r=100,filter:n=({frontmatter:l,filePathRelative:p})=>!(l.home||!p||l.article===!1||l.feed===!1),sorter:o=(l,p)=>{var d,c,g,h;return P((d=l.data.git)!=null&&d.createdTime?new Date((c=l.data.git)==null?void 0:c.createdTime):l.frontmatter.date,(g=p.data.git)!=null&&g.createdTime?new Date((h=p.data.git)==null?void 0:h.createdTime):p.frontmatter.date)}}=a,s=this.app.pages.filter(l=>l.pathLocale===t).filter(n).sort(o).slice(0,r);let u=0;for(const l of s){const p=new lt(this.app,a,l,e).getFeedItem();p&&(e.addItem(p),u+=1)}v.succeed(`added ${y.cyan(`${u} page${u>1?"s":""}`)} as feed item${u>1?"s":""} in route ${y.cyan(t)}`)}async generateFeed(){const{dest:t}=this.app.dir;await Promise.all(Object.entries(this.options).map(async([e,a])=>{if(a.atom||a.json||a.rss){const r=this.feedMap[e],{atomOutputFilename:n,jsonOutputFilename:o,rssOutputFilename:s}=k(a,e);this.addPages(e),a.atom&&(await _.ensureDir(w.dirname(t(n))),await _.outputFile(t(n),r.atom()),v.succeed(`Atom feed file generated and saved to ${y.cyan(`/${n}`)}`)),a.json&&(await _.ensureDir(w.dirname(t(o))),await _.outputFile(t(o),r.json()),v.succeed(`JSON feed file generated and saved to ${y.cyan(`${o}`)}`)),a.rss&&(await _.ensureDir(w.dirname(t(s))),await _.outputFile(t(s),r.rss()),v.succeed(`RSS feed file generated and saved to ${y.cyan(`${s}`)}`))}}))}}const pt=(i,t=!1)=>e=>{t&&q(i),e.env.isDebug&&v.info("Options:",i);const a={name:"vuepress-plugin-feed2"};if(!B(i))return v.error(`Option ${y.magenta("hostname")} is required!`),a;if(!X(i))return v.info("No requested output, the plugin won’t start!"),a;const r=z(e,i);return{...a,onPrepared:n=>Y(n,r),onGenerated:async n=>{await new ut(n,r).generateFeed()}}};export{pt as feedPlugin};
//# sourceMappingURL=index.js.map
